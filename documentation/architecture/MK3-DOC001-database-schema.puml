@startuml ERD_SaaS_Final
!theme mars

' ====================================
' AUTH SERVICE DOMAIN (Schema: auth)
' ====================================

enum Role {
  USER
  FLEET_MANAGER
  ADMIN
  SUPPORT
  MANAGER
}

enum IdentityProvider {
  LOCAL
  GOOGLE
  GITHUB
  MICROSOFT
}

entity "users" {
  * id : BIGINT <<PK, generated>>
  --
  * user_id : UUID <<UK>>
  * email : VARCHAR(255) <<UK>>
  password : VARCHAR(255)
  * provider_sub : VARCHAR(255)
  * identity_provider : VARCHAR(50)
  * role : VARCHAR(50)
  * is_active : BOOLEAN
  * email_verified : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  --
  UK: (identity_provider, provider_sub)
  INDEX: email
}

entity "user_profiles" {
  * id : BIGINT <<PK, generated>>
  --
  * user_id : UUID <<FK, UK>>
  full_name : VARCHAR(255)
  given_name : VARCHAR(255)
  family_name : VARCHAR(255)
  picture : VARCHAR(1024)
  phone : VARCHAR(20)
  date_of_birth : DATE
  driving_license_number : VARCHAR(50)
  passport_number : VARCHAR(50)
  address_line1 : VARCHAR(255)
  address_line2 : VARCHAR(255)
  city : VARCHAR(100)
  state : VARCHAR(100)
  country : VARCHAR(100)
  postal_code : VARCHAR(20)
  preferred_language : VARCHAR(10)
  country_of_residence : VARCHAR(10)
  timezone : VARCHAR(50)
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  --
  UK: user_id
}

entity "refresh_tokens" {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * token_hash : VARCHAR(64) <<UK>>
  device_info : VARCHAR(255)
  ip_address : VARCHAR(45)
  * expires_at : TIMESTAMP
  * created_at : TIMESTAMP
  last_used_at : TIMESTAMP
  * revoked : BOOLEAN
  --
  INDEX: user_id
  INDEX: expires_at
  INDEX: token_hash
}

users ||--o| user_profiles : "has one (optional)"
users ||--o{ refresh_tokens : "has many"
users }o--|| Role : "system role"
users }o--|| IdentityProvider : "auth provider"

' ====================================
' FLEET DOMAIN (Schema: fleet)
' ====================================

enum OperatorStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum MemberRole {
  OWNER
  ADMIN
  MANAGER
  VIEWER
}

enum VehicleStatus {
  AVAILABLE
  UNDER_MAINTENANCE
}

' 1. The Tenant (Company)
entity "fleet_operators" as operators {
  * id : UUID <<PK>>
  --
  * name : VARCHAR(255) <<UK>>
  * business_registration_number : VARCHAR(50) <<UK>>
  * contact_email : VARCHAR(255)
  * status : VARCHAR(20)
  logo_url : VARCHAR(1024)
  * created_at : TIMESTAMP
  activated_at : TIMESTAMP
  --
  INDEX: name
  INDEX: status
}

' 2. The Link (Staff Membership)
entity "operator_members" as members {
  * id : UUID <<PK>>
  --
  * operator_id : UUID <<FK>>
  * user_id : UUID <<FK to users.user_id>>
  * role : VARCHAR(20)
  * active : BOOLEAN
  * joined_at : TIMESTAMP
  last_active_at : TIMESTAMP
  --
  UK: (operator_id, user_id)
  UK: (user_id) WHERE active=true
  INDEX: operator_id
  INDEX: user_id
  INDEX: active
}

' 3. The Catalog (Templates)
entity "car_models" as models {
  * id : BIGINT <<PK, generated>>
  --
  * public_id : UUID <<UK>>
  * model : VARCHAR(100)
  * manufacturer : VARCHAR(100)
  * model_year : INTEGER
  * seats : INTEGER
  * luggage : INTEGER
  * transmission : VARCHAR(20)
  * fuel_type : VARCHAR(20)
  * category : VARCHAR(50)
  * image_url : VARCHAR(1024)
  engine_capacity_cc : INTEGER
  top_speed_kph : INTEGER
  zero_to_hundred_sec : DECIMAL(4,2)
  range_in_km : INTEGER
  safety_rating : VARCHAR(50)
  * has_air_conditioning : BOOLEAN
  * has_infotainment_system : BOOLEAN
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  --
  UK: (manufacturer, model, model_year)
  INDEX: (manufacturer, model)
  INDEX: category
}

' 4. The Inventory (Physical Assets)
entity "fleet_vehicles" as vehicles {
  * id : UUID <<PK>>
  --
  * operator_id : UUID <<FK>>
  * car_model_id : BIGINT <<FK>>
  * license_plate : VARCHAR(20) <<UK>>
  * daily_price : DECIMAL(10,2)
  * status : VARCHAR(20)
  chassis_number : VARCHAR(50) <<UK>>
  engine_number : VARCHAR(50) <<UK>>
  insurance_reference : VARCHAR(255)
  coe_reference : VARCHAR(255)
  primary_colour : VARCHAR(50)
  mileage_km : INTEGER
  current_location : VARCHAR(255)
  available_from : TIMESTAMP
  available_until : TIMESTAMP
  maintenance_note : TEXT
  expected_return_date : TIMESTAMP
  * created_at : TIMESTAMP
  * last_updated_at : TIMESTAMP
  --
  INDEX: operator_id
  INDEX: car_model_id
  INDEX: status
  INDEX: license_plate
}

' 5. Reservation System (Vehicle Locking)
entity "vehicle_booking_records" as records {
  * id : UUID <<PK>>
  --
  * vehicle_id : UUID <<FK>>
  * booking_id : UUID
  * booking_start_date : TIMESTAMP
  * booking_end_date : TIMESTAMP
  * reservation_status : VARCHAR(20)
  expires_at : TIMESTAMP
  payment_reference : VARCHAR(255)
  notes : TEXT
  * created_at : TIMESTAMP
  confirmed_at : TIMESTAMP
  cancelled_at : TIMESTAMP
  * last_updated_at : TIMESTAMP
  --
  UK: (vehicle_id, booking_id)
  INDEX: vehicle_id, booking_start_date, booking_end_date
  INDEX: booking_id
  INDEX: reservation_status, expires_at
}

' ====================================
' BOOKING DOMAIN (Schema: booking)
' ====================================

enum BookingStatus {
  PENDING_RESERVATION
  PENDING_PAYMENT
  PENDING_CONFIRMATION
  CONFIRMED
  RESERVATION_EXPIRED
  PAYMENT_FAILED
  CANCELLED
  COMPLETED
}

entity "bookings" as bookings {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK to users.user_id>>
  * car_model_public_id : UUID <<FK to car_models.public_id>>
  vehicle_id : UUID
  reservation_id : UUID
  * start_date : TIMESTAMP
  * end_date : TIMESTAMP
  * pickup_location : VARCHAR(255)
  * return_location : VARCHAR(255)
  * status : VARCHAR(50)
  payment_id : UUID
  payment_reference : VARCHAR(255)
  * total_amount : DECIMAL(10,2)
  * currency : VARCHAR(3)
  driver_details : JSONB
  * created_at : TIMESTAMP
  reservation_expires_at : TIMESTAMP
  payment_completed_at : TIMESTAMP
  confirmed_at : TIMESTAMP
  cancelled_at : TIMESTAMP
  --
  INDEX: user_id
  INDEX: status
  INDEX: created_at
  INDEX: vehicle_id
  INDEX: (user_id, status)
}

' ====================================
' TELEMETRY & ML DOMAIN (Schema: telemetry)
' ====================================

enum TripStatus {
  PENDING_ANALYSIS
  PROCESSING
  COMPLETED
  FAILED
}

entity "trip_data_raw" as trips {
  * id : UUID <<PK>>
  --
  * vehicle_id : UUID <<FK>>
  * driver_id : UUID <<FK>>
  * start_time : TIMESTAMP
  * end_time : TIMESTAMP
  
  * raw_telemetry_blob : JSONB 
  
  * status : VARCHAR(20) <<TripStatus>>
  * created_at : TIMESTAMP
  --
  INDEX: vehicle_id
  INDEX: status
}

entity "driver_scores" as scores {
  * id : UUID <<PK>>
  --
  * trip_id : UUID <<FK, UK>>
  * vehicle_id : UUID <<FK>>
  * driver_id : UUID <<FK>>
  
  * safety_score : INTEGER (0-100)
  
  harsh_braking_count : INTEGER
  rapid_accel_count : INTEGER
  speeding_count : INTEGER
  
  * created_at : TIMESTAMP
  --
  INDEX: driver_id
  INDEX: safety_score
}

' ====================================
' RELATIONSHIPS
' ====================================

' Auth Service Internal
users ||--o| user_profiles : "optional profile"
users ||--o{ refresh_tokens : "many tokens"

' Fleet Operator Domain
operators ||--o{ members : "employs 0+ staff"
users ||--o| members : "optionally member of 0..1 operator"
operators }o--|| OperatorStatus : "has status"
members }o--|| MemberRole : "has role"

' Fleet Inventory Domain
operators ||--o{ vehicles : "owns many"
models ||--o{ vehicles : "instantiates"
vehicles }o--|| VehicleStatus : "has status"

' Reservation System
vehicles ||--o{ records : "reserved 0+ times"

' Cross-Module (Logical - Shared DB)
users ||--o{ bookings : "makes bookings"
models ||--o{ bookings : "booked as model"
vehicles ||--o{ bookings : "assigned to"
bookings ||--o| records : "creates temp reservation"
bookings }o--|| BookingStatus : "has status"

' Telemetry
vehicles ||--o{ trips : "records"
trips ||--|| scores : "generates"

' ====================================
' NOTES
' ====================================

note right of members
  ðŸ”¥ TWO-STAGE SECURITY:
  Layer 1: Auth Service Role (JWT)
  Layer 2: Fleet Internal Role (DB)
end note

note bottom of bookings
  ðŸ“¦ MODULAR MONOLITH
  Fleet, Booking, and Telemetry
  share the same Physical DB
  but use separate Schemas.
end note

note left of trips
  ðŸ¤– CLAIM CHECK PATTERN
  1. Core Service saves huge JSON here.
  2. Core sends ID to RabbitMQ.
  3. ML Service reads JSON from here.
  4. ML Service writes Score to 'driver_scores'.
end note

@enduml
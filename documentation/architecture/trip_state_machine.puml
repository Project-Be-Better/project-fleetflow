@startuml trip_state_machine
title Trip Processing State Machine

[*] --> PENDING_ANALYSIS : Trip Created

state PENDING_ANALYSIS {
    [*] -> PENDING_ANALYSIS
    note on link
        A new trip is logged and
        a message is sent to the
        RabbitMQ queue.
    end note
}

PENDING_ANALYSIS --> PROCESSING : process_message
note on link
    The worker consumes the
    message from the queue.
end note

state PROCESSING {
    PROCESSING --> COMPLETED : analysis_success
    note on link
        The safety score is calculated
        and saved without errors.
    end note

    PROCESSING --> FAILED : analysis_error
    note on link
        An exception occurred during
        database access or analytics.
    end note
}

FAILED --> PROCESSING : retry_message
note on link
    The message is redelivered
    by RabbitMQ to be tried again.
end note

FAILED --> [*] : retry_limit_exceeded
note on link
    The message is moved to a
    dead-letter queue after
    'n' failed attempts.
end note

COMPLETED --> [*]
note on link
    The trip is fully processed
    and has reached a terminal state.
end note

@enduml

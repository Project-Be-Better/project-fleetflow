@startuml
!theme mars
autonumber

actor "Simulator / Car" as car
participant "FastAPI\n(Ingestion Service)" as api
database "PostgreSQL\n(trip_logs)" as db_raw
queue "RabbitMQ" as mq
participant "Python Worker\n(Analysis Engine)" as worker
database "PostgreSQL\n(driver_scores)" as db_score

== Phase 1: Ingestion (Fast) ==
car -> api: POST /api/v1/telemetry\n{JSON Payload}
activate api

api -> db_raw: INSERT INTO trip_logs (status='PENDING_ANALYSIS')
activate db_raw
db_raw --> api: Success
deactivate db_raw

api -> mq: Publish Message\n{trip_id: "uuid"}
api --> car: 202 Accepted\n{"trip_id": "uuid"}
deactivate api
note right: Client is released here.\nDoes not wait for ML.

== Phase 2: Processing (Async) ==
mq -> worker: Consume Message\n{trip_id: "uuid"}
activate worker

worker -> db_raw: UPDATE status='PROCESSING'
worker -> db_raw: SELECT blob FROM trip_logs
activate db_raw
db_raw --> worker: Returns {JSON Payload}
deactivate db_raw

worker -> worker: NumPy Analysis\n(Vector Calculations)

worker -> db_score: INSERT INTO driver_scores
activate db_score
db_score --> worker: Success
deactivate db_score

worker -> db_raw: UPDATE status='COMPLETED'
deactivate worker

@enduml